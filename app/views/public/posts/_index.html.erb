<div class="row mt-5 ">
  <div class="mx-auto">
  <%=  form_with url: order_posts_path ,method: :get, local: true do |f| %>
    <div>
      <%= f.select :keyword,[ ['投稿が新しい順', 'new'], ['投稿が古い順', 'old'], ['いいねの多い順', 'likes'] ]%>
    </div>
    <div>
      <%= f.submit %>
    </div>
  <% end %>
  </div>
</div>

<div class="row mt-5" >
  <% posts.each do |post| %>
  <div class="col-lg-5  offset-lg-1  col-8 offset-2" style="margin-top: 150px; " >
    <div class="card mt-4 shadow-lg h-100" >
      <div>
        <%= link_to post_path(post) do %>
          <%= attachment_image_tag post,:picture,:fill,300,300,size: "300x300", class: "card-img-top"%>
        <% end %>
      </div>
      <div class="card-body">
        <%# 名前と画像 %>
        <div class="card-text" >
          <%= link_to listener_path(post.listener),class: "text-dark" do %>
          <div class="d-inline-block">
            <%= attachment_image_tag post.listener,:profile_image ,size:"50x50", fallback: "no_image.jpg",class: "mt-3 rounded-circle" %>
          </div>
          <div class="d-inline-block">
            <% if post.listener.listener_type == 1  %>
              <i class="fa fa-circle" style="color: gold;"></i>
            <% end %>
            <%= post.listener.name%>
          </div>
          <% end %>
        </div>
        <%# 投稿文 %>
        <h3 class="card-text text-center"><%= post.post_tweet  %></h4>
        <!--タグ一覧-->
        <p class="card-text text-center">
          <% post.tags.each do |tag| %>
            <%= link_to tag.tag_name, search_tag_posts_path(tag_id: tag.id) %>
          <% end %>
        </p>
        <div class="card shadow-sm ">
          <div class="row no-gutters">
            <div class="col-md-4 my-auto">
              <img class="card-img" id="link_img_<%= post.id %>" style="width:150px; height:100px;" src=""/>
            </div>
            <div class="col-md-8">
              <div class="card-body">
                <a class="card-title" id="link_<%= post.id %>" href="<%= post.post_url %>" target="_blank"><h5 id="linkpreview_<%= post.id %>"></h5></a>
              </div>
            </div>
          </div>
        </div>
        <!--詳細ページへ-->
        <p class="card-text text-center"><%= link_to "show" ,post_path(post) %></p>

        <%# 投稿日 %>
        <div class="text-right mt-3"><%= time_ago_in_words(post.created_at) %></div>
      </div>
    </div>
  </div>
  <script>
    const data_<%= post.id %> = {
      key:'3ce2027b63ce4b30403332b3eb475fbe',
      q: "<%= post.post_url%>"
    }
    //プレビュー表示用の関数
    const createIMG_<%= post.id %> = json => {
      document.querySelector('#link_img_<%= post.id %>').src = json.image;
      document.querySelector('#linkpreview_<%= post.id %>').textContent = json.title;
      // document.querySelector('#linkcaption_<%= post.id %>').textContent = json.description;
      document.querySelector('#link_<%= post.id %>').href = json.url;
    }
    //LinkPreviewを利用した通信処理
    fetch('https://api.linkpreview.net', {
      method: 'POST',
      mode: 'cors',
      body: JSON.stringify(data_<%= post.id %>),
    })
    .then(data_<%= post.id %> => data_<%= post.id %>.json())
    .then(json => createIMG_<%= post.id %>(json));
  </script>
  <% end %>
</div>
<div class="row mt-5">
    <div class="">
      <%= paginate posts %>
    </div>
</div>